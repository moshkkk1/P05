#include <math.h>          // Подключение математической библиотеки для возможных расчетов
#include <ncurses.h>       // Подключение библиотеки ncurses для работы с текстовым интерфейсом
#include <stdio.h>         // Подключение стандартной библиотеки ввода-вывода

/*
ИНИЦИАЛИЗАЦИЯ ГЛОБАЛЬНЫХ КОНСТАНТ
==================================
Константы определяют размеры игрового поля и параметры игры
*/
#define WIDTH 80           // Ширина игрового поля в символах (80 символов)
#define HEIGHT 25          // Высота игрового поля в символах (25 символов)
#define WIN 21             // Количество очков для победы (21 очко)
#define PADDLE_SIZE 3      // Высота ракетки в символах (3 символа)
#define BALL_SIZE 1        // Размер мяча (всегда 1 символ)

/*
ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
=====================
Хранят текущее состояние игры и доступны из любой функции
*/
int y_pad1;               // Y-координата верхней части левой ракетки
int y_pad2;               // Y-координата верхней части правой ракетки

int y_ball, x_ball;       // Текущие координаты мяча (Y и X)
int dx, dy;               // Скорость и направление движения мяча (изменение X и Y за шаг)

int score1 = 0;           // Счет первого игрока (левая ракетка)
int score2 = 0;           // Счет второго игрока (правая ракетка)

/*
ФУНКЦИЯ ИНИЦИАЛИЗАЦИИ
====================
Устанавливает начальные значения всех переменных при запуске игры
*/
void init(void) {         // Функция без параметров, которая инициализирует игру
  y_pad1 = (HEIGHT - PADDLE_SIZE) / 2;  // Ставим левую ракетку в центр по вертикали
  y_pad2 = (HEIGHT - PADDLE_SIZE) / 2;  // Ставим правую ракетку в центр по вертикали

  y_ball = HEIGHT / 2;    // Ставим мяч в центр по вертикали
  x_ball = WIDTH / 2;     // Ставим мяч в центр по горизонтали
  dx = 1;                 // Мяч движется вправо (увеличение X)
  dy = 1;                 // Мяч движется вниз (увеличение Y)

  score1 = 0;             // Обнуляем счет первого игрока
  score2 = 0;             // Обнуляем счет второго игрока
}

/*
ФУНКЦИЯ ДВИЖЕНИЯ РАКЕТОК
=======================
Обрабатывает нажатия клавиш для движения ракеток игроков
*/
void move_pad(char z) {   // Функция принимает символ нажатой клавиши
  switch (z) {            // Проверяем, какая клавиша была нажата
  case 'A':               // Если нажата заглавная буква А
  case 'a':               // Если нажата строчная буква а
    if (y_pad1 > 1) {     // Проверяем, что ракетка не упирается в верхнюю границу
      y_pad1--;           // Двигаем левую ракетку вверх (уменьшаем Y)
    }
    break;                // Завершаем обработку этого случая
  case 'Z':               // Если нажата заглавная буква Z
  case 'z':               // Если нажата строчная буква z
    if (y_pad1 < HEIGHT - PADDLE_SIZE - 1) {  // Проверяем нижнюю границу
      y_pad1++;           // Двигаем левую ракетку вниз (увеличиваем Y)
    }
    break;
  case 'K':               // Если нажата заглавная буква K
  case 'k':               // Если нажата строчная буква k
    if (y_pad2 > 1) {     // Проверяем верхнюю границу для правой ракетки
      y_pad2--;           // Двигаем правую ракетку вверх
    }
    break;
  case 'M':               // Если нажата заглавная буква M
  case 'm':               // Если нажата строчная буква m
    if (y_pad2 < HEIGHT - PADDLE_SIZE - 1) {  // Проверяем нижнюю границу
      y_pad2++;           // Двигаем правую ракетку вниз
    }
    break;
  default:                // Если нажата любая другая клавиша
    break;                // Ничего не делаем
  }
}

/*
ФУНКЦИЯ ДВИЖЕНИЯ МЯЧА
====================
Обновляет позицию мяча и обрабатывает столкновения
*/
void move_ball(void) {    // Функция движения мяча без параметров
  x_ball += dx;           // Изменяем X-координату мяча на значение dx
  y_ball += dy;           // Изменяем Y-координату мяча на значение dy

  // ОТСКОК ОТ ВЕРХНЕЙ И НИЖНЕЙ ГРАНИЦ ПОЛЯ
  if (y_ball <= 0) {      // Если мяч коснулся верхней границы (Y=0)
    y_ball = 1;           // Возвращаем мяч внутрь поля
    dy = 1;               // Меняем направление на движение вниз
  }

  if (y_ball >= HEIGHT - 1) {  // Если мяч коснулся нижней границы
    y_ball = HEIGHT - 2;       // Возвращаем мяч внутрь поля
    dy = -1;                   // Меняем направление на движение вверх
  }

  // ОТСКОК ОТ ЛЕВОЙ РАКЕТКИ
  if (x_ball == 1 && y_ball >= y_pad1 && y_ball < y_pad1 + PADDLE_SIZE) {
    // Проверяем, что мяч касается левой ракетки (X=1) и находится в пределах её высоты
    dx = 1;                    // Меняем направление на движение вправо
    int hit_pos = y_ball - y_pad1;  // Вычисляем, в какую часть ракетки попал мяч
    if (hit_pos == 0) {        // Если мяч попал в верхнюю часть ракетки
      dy = -1;                 // Отправляем мяч вверх
    } else if (hit_pos == PADDLE_SIZE - 1) {  // Если попал в нижнюю часть
      dy = 1;                  // Отправляем мяч вниз
    }
  }
  // ОТСКОК ОТ ПРАВОЙ РАКЕТКИ
  else if (x_ball == WIDTH - 2 && y_ball >= y_pad2 &&
           y_ball < y_pad2 + PADDLE_SIZE) {
    // Аналогичная логика для правой ракетки
    dx = -1;                   // Меняем направление на движение влево
    int hit_pos = y_ball - y_pad2;  // Вычисляем позицию попадания
    if (hit_pos == 0) {        // Верхняя часть ракетки
      dy = -1;                 // Мяч идет вверх
    } else if (hit_pos == PADDLE_SIZE - 1) {  // Нижняя часть ракетки
      dy = 1;                  // Мяч идет вниз
    }
  }

  // ГОЛЫ - МЯЧ ВЫШЕЛ ЗА ПРЕДЕЛЫ ПОЛЯ
  if (x_ball < 0) {            // Если мяч вышел за левую границу поля
    score2++;                  // Засчитываем очко второму игроку
    x_ball = WIDTH / 2;        // Возвращаем мяч в центр
    y_ball = HEIGHT / 2;
    dx = 1;                    // Мяч снова движется вправо
    dy = 1;                    // И вниз
  } else if (x_ball >= WIDTH) {  // Если мяч вышел за правую границу
    score1++;                  // Засчитываем очко первому игроку
    x_ball = WIDTH / 2;        // Возвращаем мяч в центр
    y_ball = HEIGHT / 2;
    dx = -1;                   // Мяч теперь движется влево
    dy = 1;                    // И вниз
  }
}

/*
ФУНКЦИЯ ЗАДЕРЖКИ
================
Создает паузу между кадрами игры для контроля скорости
*/
void simple_delay(void) {      // Простая функция задержки
  for (int i = 0; i < 100000000; i++) {  // Цикл с большим количеством итераций
    // Пустой цикл просто тратит время процессора
  }
}

/*
ФУНКЦИЯ ОТРИСОВКИ
=================
Рисует весь игровой интерфейс на экране
*/
void draw_playground(void) {   // Функция отрисовки игрового поля
  clear();                     // Очищаем весь экран от предыдущего кадра

  // ОТРИСОВКА ЗАГОЛОВКА И СЧЕТА
  mvprintw(0, (WIDTH - 30) / 2, "=== PONG GAME ===");  // Заголовок по центру
  mvprintw(1, (WIDTH - 25) / 2, "Player 1: %d  |  Player 2: %d", score1, score2);  // Счет игроков
  mvprintw(2, (WIDTH - 35) / 2, "First to %d wins! (Q to quit)", WIN);  // Информация о победе

  // ОТРИСОВКА ИГРОВОГО ПОЛЯ
  for (int i = 3; i < HEIGHT + 2; i++) {     // Цикл по высоте поля (начиная с 3-й строки)
    for (int j = 0; j < WIDTH; j++) {        // Цикл по ширине поля
      // РИСОВАНИЕ ГРАНИЦ ПОЛЯ
      if (i == 3 || i == HEIGHT + 1) {       // Если это верхняя или нижняя граница
        if (j == 0 || j == WIDTH - 1)        // Углы поля
          mvaddch(i, j, '+');                // Рисуем плюс в углах
        else                                 // Стороны границ
          mvaddch(i, j, '-');                // Рисуем дефисы
      } else if (j == 0 || j == WIDTH - 1) {  // Левая и правая границы
        mvaddch(i, j, '|');                  // Рисуем вертикальные линии
      } else {
        // РИСОВАНИЕ РАКЕТОК И МЯЧА
        // Левая ракетка (находится на X=1)
        if (j == 1 && i - 3 >= y_pad1 && i - 3 < y_pad1 + PADDLE_SIZE) {
          mvaddch(i, j, '|');                // Рисуем вертикальную черту (ракетку)
        }
        // Правая ракетка (находится на X=WIDTH-2)
        else if (j == WIDTH - 2 && i - 3 >= y_pad2 &&
                 i - 3 < y_pad2 + PADDLE_SIZE) {
          mvaddch(i, j, '|');                // Рисуем правую ракетку
        }
        // Мяч (рисуется только если координаты совпадают)
        else if (j == x_ball && i - 3 == y_ball) {
          mvaddch(i, j, 'O');                // Рисуем мяч как круг
        }
      }
    }
  }

  // ОТРИСОВКА ИНФОРМАЦИИ ОБ УПРАВЛЕНИИ
  mvprintw(HEIGHT + 3, 2, "Controls: A/Z - Player 1, K/M - Player 2, Q - Quit");

  refresh();                   // Обновляем экран, показывая все изменения
}

/*
ОСНОВНАЯ ФУНКЦИЯ ПРОГРАММЫ
=========================
Главный игровой цикл и инициализация ncurses
*/
int main(void) {               // Точка входа в программу
  // ИНИЦИАЛИЗАЦИЯ БИБЛИОТЕКИ NCURSES
  initscr();                   // Инициализирует ncurses, подготавливает экран
  cbreak();                    // Включает немедленный ввод без ожидания Enter
  noecho();                    // Отключает отображение введенных символов на экране
  keypad(stdscr, TRUE);        // Включает обработку специальных клавиш (стрелки, функциональные клавиши)
  timeout(0);                  // Устанавливает неблокирующий ввод (не ждет нажатия клавиши)

  // ПРИВЕТСТВЕННОЕ СООБЩЕНИЕ
  printf("=== ИГРА В ПОНГ (ИНТЕРАКТИВНАЯ ВЕРСИЯ) ===\n");
  printf("Управление:\n");
  printf("Игрок 1 (левая ракетка): A - вверх, Z - вниз\n");
  printf("Игрок 2 (правая ракетка): K - вверх, M - вниз\n");
  printf("Выход из игры: Q\n");
  printf("Игра ведется в реальном времени.\n");
  printf("Мяч движется автоматически, вы управляете только ракетками!\n");
  printf("Нажмите любую клавишу для начала игры...\n");
  getch();                     // Ждет нажатия любой клавиши, чтобы начать игру

  init();                      // Инициализируем игровые переменные

  int game_running = 1;        // Флаг, определяющий продолжается ли игра

  // ГЛАВНЫЙ ИГРОВОЙ ЦИКЛ
  while (game_running && score1 < WIN && score2 < WIN) {
    // ОБРАБОТКА ВВОДА
    int ch = getch();          // Читаем символ с клавиатуры

    if (ch != ERR) {           // Если была нажата какая-то клавиша (не ошибка)
      switch (ch) {            // Проверяем, какая клавиша нажата
      case 'A': case 'a': case 'Z': case 'z': case 'K': case 'k': case 'M': case 'm':
        move_pad((char)ch);    // Вызываем функцию движения ракетки
        break;
      case 'Q': case 'q':      // Если нажата Q или q
        game_running = 0;      // Устанавливаем флаг остановки игры
        break;
      default:                 // Любая другая клавиша
        break;                 // Игнорируем
      }
    }

    // ДВИЖЕНИЕ И ОТРИСОВКА
    move_ball();               // Обновляем позицию мяча и обрабатываем столкновения
    draw_playground();         // Рисуем обновленное игровое поле
    simple_delay();            // Делаем небольшую паузу для контроля скорости игры
  }

  // ЗАВЕРШЕНИЕ ИГРЫ
  endwin();                    // Завершаем ncurses и возвращаем терминал в обычное состояние

  printf("\n=== ИГРА ЗАВЕРШЕНА ===\n");
  printf("Player 1: %d очков\n", score1);  // Показываем итоговый счет первого игрока
  printf("Player 2: %d очков\n", score2);  // Показываем итоговый счет второго игрока

  // ОПРЕДЕЛЕНИЕ ПОБЕДИТЕЛЯ
  if (score1 == WIN) {         // Если первый игрок набрал нужное количество очков
    printf("Победитель: Player 1!\n");     // Объявляем первого игрока победителем
  } else if (score2 == WIN) {  // Если второй игрок набрал нужное количество очков
    printf("Победитель: Player 2!\n");     // Объявляем второго игрока победителем
  }

  return 0;                    // Завершаем программу с кодом успеха
}

/*
ОБЪЯСНЕНИЕ ОСНОВНЫХ КОНЦЕПЦИЙ:

1. БИБЛИОТЕКА NCURSES:
   - Позволяет создавать текстовый интерфейс в терминале
   - Управляет курсором, экраном и вводом с клавиатуры
   - Создает иллюзию графики в текстовом режиме

2. ИГРОВОЙ ЦИКЛ:
   - Бесконечный цикл, который повторяется пока игра не закончится
   - На каждой итерации: обрабатываем ввод → обновляем состояние → рисуем

3. ФИЗИКА ИГРЫ:
   - Мяч движется с постоянной скоростью
   - Отскакивает от стен и ракеток под разными углами
   - Углы зависят от того, в какую часть ракетки попал мяч

4. УПРАВЛЕНИЕ:
   - Неблокирующий ввод позволяет мячу двигаться постоянно
   - Игроки могут нажимать клавиши в любой момент

5. КООРДИНАТНАЯ СИСТЕМА:
   - (0,0) - верхний левый угол экрана
   - Y увеличивается вниз, X увеличивается вправо
   - Игровое поле начинается с Y=3 для размещения заголовка
*/