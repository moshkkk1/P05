#include <stdio.h>  // Подключаем библиотеку для ввода/вывода (printf, getchar и т.д.)

/*
Инициализация глобальных переменных:
1) Для ракеток
2) Для мяча - координаты и направление  
3) Для игрока, его очки
*/
#define WIDTH 80      // Ширина игрового поля в символах
#define HEIGHT 25     // Высота игрового поля в символах
#define WIN 21        // Количество очков для победы

int y_pad1;           // Y левой ракетки (верхний край)
int y_pad2;           // Y-координа-координатата правой ракетки (верхний край)

int y_ball, x_ball;   // Координаты мяча: y_ball - вертикальная, x_ball - горизонтальная
int dx, dy;           // Направление движения мяча: dx - по X, dy - по Y

int score1 = 0;       // Счёт игрока 1 (левая ракетка)
int score2 = 0;       // Счёт игрока 2 (правая ракетка)

/*
Функция инициализации игры.
Устанавливает начальные позиции всех объектов и обнуляет счёт.
Цифры (HEIGHT - 3) / 2 ставят ракетки в центр поля по вертикали.
*/
void init(void) {
    // Устанавливаем левую ракетку в центр поля по вертикали
    y_pad1 = (HEIGHT - 3) / 2;  // HEIGHT-3 потому что ракетка занимает 3 клетки
    // Устанавливаем правую ракетку в центр поля по вертикали  
    y_pad2 = (HEIGHT - 3) / 2;

    // Устанавливаем мяч в центр поля
    y_ball = HEIGHT / 2;  // Центр по вертикали
    x_ball = WIDTH / 2;   // Центр по горизонтали
    
    // Устанавливаем начальное направление движения мяча
    dx = 1;  // Движение вправо (положительное направление по X)
    dy = 1;  // Движение вниз (положительное направление по Y)

    // Обнуляем счёт игроков
    score1 = 0;
    score2 = 0;
}

/*
Функция движения ракеток.
Принимает символ команды и перемещает соответствующую ракетку.
Используется switch для выбора действия в зависимости от нажатой клавиши.
*/
void move_pad(char z) {
    // Проверяем какая клавиша была нажата
    switch (z) {
    // Игрок 1 (левая ракетка) - движение вверх
    case 'A':  // Заглавная буква A
    case 'a':  // Строчная буква a
        // Проверяем не выходим ли за верхнюю границу поля
        if (y_pad1 > 1) {  // 1 - потому что 0 это граница поля
            y_pad1--;      // Двигаем ракетку вверх (уменьшаем Y)
        }
        break;             // Выходим из switch
    
    // Игрок 1 (левая ракетка) - движение вниз
    case 'Z':
    case 'z':
        // Проверяем не выходим ли за нижнюю границу поля
        if (y_pad1 < 21) {  // 21 = HEIGHT - 3 - 1 (оставляем место для нижней границы)
            y_pad1++;       // Двигаем ракетку вниз (увеличиваем Y)
        }
        break;
    
    // Игрок 2 (правая ракетка) - движение вверх
    case 'K':
    case 'k':
        if (y_pad2 > 1) {
            y_pad2--;
        }
        break;
    
    // Игрок 2 (правая ракетка) - движение вниз
    case 'M':
    case 'm':
        if (y_pad2 < 21) {
            y_pad2++;
        }
        break;
    
    // Пропуск хода (пробел)
    case ' ':
        break;  // Ничего не делаем
    
    // Любая другая клавиша - игнорируем
    default:
        break;
    }
}

/*
Функция движения мяча.
Обновляет позицию мяча и проверяет столкновения с границами и ракетками.
*/
void move_ball(void) {
    // Двигаем мяч в соответствии с его направлением
    x_ball += dx;  // Изменяем X-координату (влево или вправо)
    y_ball += dy;  // Изменяем Y-координату (вверх или вниз)

    // Проверяем столкновение с верхней границей поля
    if (y_ball <= 0) {  // Мяч коснулся верхней границы
        y_ball = 1;     // Возвращаем мяч внутрь поля
        dy = 1;         // Меняем направление на движение вниз
    }

    // Проверяем столкновение с нижней границей поля
    if (y_ball >= HEIGHT - 1) {  // Мяч коснулся нижней границы
        y_ball = HEIGHT - 2;     // Возвращаем мяч внутрь поля
        dy = -1;                 // Меняем направление на движение вверх
    }

    /*
    Проверяем столкновение с ракетками.
    Ракетка имеет 3 секции: верхняя (hit_pos == 0), средняя (hit_pos == 1), нижняя (hit_pos == 2).
    От направления попадания зависит угол отскока мяча.
    */
    
    // Столкновение с левой ракеткой
    if (x_ball == 1 && y_ball >= y_pad1 && y_ball < y_pad1 + 3) {
        dx = 1;  // Меняем направление на движение вправо
        // Определяем в какую часть ракетки попал мяч
        int hit_pos = y_ball - y_pad1;  // Вычисляем позицию попадания (0, 1 или 2)
        
        if (hit_pos == 0) {  // Попадание в верхнюю часть ракетки
            dy = -1;         // Мяч полетит вверх
        }
        else if (hit_pos == 2) {  // Попадание в нижнюю часть ракетки
            dy = 1;          // Мяч полетит вниз
        }
        // Если hit_pos == 1 (средняя часть), направление по Y не меняется
    }
    
    // Столкновение с правой ракеткой  
    else if (x_ball == WIDTH - 2 && y_ball >= y_pad2 && y_ball < y_pad2 + 3) {
        dx = -1;  // Меняем направление на движение влево
        // Определяем в какую часть ракетки попал мяч
        int hit_pos = y_ball - y_pad2;  // Вычисляем позицию попадания (0, 1 или 2)
        
        if (hit_pos == 0) {  // Попадание в верхнюю часть ракетки
            dy = -1;         // Мяч полетит вверх
        }
        else if (hit_pos == 2) {  // Попадание в нижнюю часть ракетки
            dy = 1;          // Мяч полетит вниз
        }
    }

    /*
    Проверяем голы (когда мяч полностью выходит за границы поля по X).
    Если мяч прошёл левую границу - гол для игрока 2.
    Если мяч прошёл правую границу - гол для игрока 1.
    */
    
    // Гол для игрока 2 (мяч вышел за левую границу)
    if (x_ball < 0) {
        score2++;  // Увеличиваем счёт игрока 2
        
        // Возвращаем мяч в центр поля для продолжения игры
        x_ball = WIDTH / 2;
        y_ball = HEIGHT / 2;
        dx = 1;   // Мяч будет лететь вправо
        dy = 1;   // Мяч будет лететь вниз
    }
    
    // Гол для игрока 1 (мяч вышел за правую границу)
    else if (x_ball >= WIDTH) {
        score1++;  // Увеличиваем счёт игрока 1
        
        // Возвращаем мяч в центр поля для продолжения игры
        x_ball = WIDTH / 2;
        y_ball = HEIGHT / 2;
        dx = -1;  // Мяч будет лететь влево
        dy = 1;   // Мяч будет лететь вниз
    }
}

/*
Функция чтения команды от игрока.
Обеспечивает пошаговый режим игры - игроки по очереди вводят команды.
Проверяет корректность ввода и запрашивает повтор если ввод неверный.
*/
char read_command(void) {
    char c;        // Переменная для хранения введённого символа
    int valid_input = 0;  // Флаг корректности ввода (0 = неверный, 1 = верный)
    
    // Цикл продолжается пока ввод не станет корректным
    while (!valid_input) {
        // Просим игрока ввести команду
        printf("\nВведите команду (A/Z - игрок 1, K/M - игрок 2, Space - пропуск хода): ");
        c = getchar();  // Читаем один символ с клавиатуры
        
        // Очищаем буфер ввода от оставшихся символов (перенос строки и т.д.)
        while (getchar() != '\n');  // Читаем символы до переноса строки
        
        // Проверяем является ли введённый символ допустимой командой
        if (c == 'A' || c == 'a' || c == 'Z' || c == 'z' ||  // Команды игрока 1
            c == 'K' || c == 'k' || c == 'M' || c == 'm' ||  // Команды игрока 2
            c == ' ') {  // Пропуск хода
            valid_input = 1;  // Ввод корректный, выходим из цикла
        } else {
            // Выводим сообщение об ошибке и просим ввести снова
            printf("Неверная команда! Используйте A, Z, K, M или Space.\n");
        }
    }
    
    return c;  // Возвращаем корректную команду
}

/*
Функция отрисовки игрового поля.
Рисует границы, ракетки, мяч и счёт игроков.
Использует циклы для построчного вывода символов.
*/
void playground(void) {
    // Выводим счёт игроков в заголовке
    printf("=== Player 1: %d  |  Player 2: %d === (first to %d wins)\n", score1, score2, WIN);
    
    // Внешний цикл - проходим по каждой строке поля (по вертикали)
    for (int i = 0; i < HEIGHT; i++) {
        // Внутренний цикл - проходим по каждому символу в строке (по горизонтали)
        for (int j = 0; j < WIDTH; j++) {
            char cell = ' ';  // Текущий символ для вывода (по умолчанию пробел)
            
            // Проверяем границы поля
            if (i == 0 || i == HEIGHT - 1) {  // Верхняя или нижняя граница
                if (j == 0 || j == WIDTH - 1)  // Углы поля
                    cell = '+';  // Рисуем угол
                else
                    cell = '-';  // Рисуем горизонтальную границу
            }
            else if (j == 0 || j == WIDTH - 1) {  // Левая или правая граница
                cell = '|';  // Рисуем вертикальную границу
            }
            else {
                // Рисуем левую ракетку (позиция x = 1)
                if (j == 1 && i >= y_pad1 && i < y_pad1 + 3) {
                    cell = '|';  // Рисуем часть ракетки
                }
                // Рисуем правую ракетку (позиция x = WIDTH - 2)
                else if (j == WIDTH - 2 && i >= y_pad2 && i < y_pad2 + 3) {
                    cell = '|';  // Рисуем часть ракетки
                }
                // Рисуем мяч (проверяем совпадение координат)
                else if (j == x_ball && i == y_ball) {
                    cell = 'O';  // Рисуем мяч
                }
            }
            
            // Выводим текущий символ без переноса строки
            printf("%c", cell);
        }
        // После каждой строки делаем перенос строки
        printf("\n");
    }
}

/*
Главная функция программы.
Управляет основным циклом игры и協調ирует работу всех компонентов.
Игра идёт в пошаговом режиме до достижения одного из игроков 21 очка.
*/
int main(void) {
    // Выводим приветствие и правила игры
    printf("=== ИГРА В ПОНГ ===\n");
    printf("Управление:\n");
    printf("Игрок 1 (левая ракетка): A - вверх, Z - вниз\n");
    printf("Игрок 2 (правая ракетка): K - вверх, M - вниз\n");
    printf("Пропуск хода: Space Bar\n");
    printf("Игра ведется в пошаговом режиме.\n");
    printf("После каждого действия происходит отрисовка поля.\n");
    printf("Первый игрок, набравший %d очков, побеждает!\n", WIN);
    printf("Нажмите Enter для начала игры...\n");
    
    // Ждём нажатия Enter перед началом игры
    getchar();
    
    // Инициализируем игру (позиции, счёт, направления)
    init();
    
    char cmd;  // Переменная для хранения команды игрока
    
    // Основной игровой цикл - продолжается пока кто-то не наберёт WIN очков
    while (score1 < WIN && score2 < WIN) {
        playground();    // 1. Рисуем текущее состояние поля
        cmd = read_command();  // 2. Ждём команду от игрока
        move_pad(cmd);   // 3. Перемещаем ракетку согласно команде
        move_ball();     // 4. Двигаем мяч и проверяем столкновения
    }
    
    // Игра окончена - выводим результат
    printf("\nИгра завершена!\n");
    printf("Player 1: %d очков\n", score1);
    printf("Player 2: %d очков\n", score2);
    
    // Определяем и объявляем победителя
    if (score1 == WIN) {
        printf("Победитель: Player 1!\n");
    } else if (score2 == WIN) {
        printf("Победитель: Player 2!\n");
    }
    
    return 0;  // Программа завершена успешно
}